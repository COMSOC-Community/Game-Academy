{% extends 'core/base_game.html' %}
{% load core_extras %}

{% load static %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/ngstyle.css' %}"/>
    <script src="{% static 'js/collapsible_next.js' %}"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-cartesian.min.js"></script>
{% endblock %}

{% block game_content %}
    {% if answers_sorted_round_robin %}
        <section>
            <h2 class="next-collapsible">Competing Against the Optimal Strategy</h2>

            <div class="collapsed-content hidden">
                <p>
                    This game has a theoretically optimal strategy which is: always bet with the King or the Queen
                    and bet with probability 1/3 with the Jack; always call with the King, call with probability
                    1/3 with the Queen, and never call with the Jack.
                </p>

                <p>
                    We compared the submitted strategies to the optimal one.
                </p>

                {% if user_is_session_admin %}
                    <p class="next-collapsible">
                        Display winners
                    </p>
                    <p class="collapsed-content hidden center-align">
                        {{ formatted_winners_against_opt|safe }}
                    </p>
                {% endif %}

                <table class="lined-table center-margin">
                    <tr>
                        <th>Answer</th>
                        <th>Score against OPT</th>
                        <th>Justification</th>
                    </tr>
                    {% for answer in answers_sorted_against_opt %}
                        <tr>
                            <td {% if answer.winner_against_optimum %}class="winning"{% endif %}>{% include 'include/answer_as_tuple.html' %}</td>
                            <td {% if answer.winner_against_optimum %}class="winning"{% endif %}>{{ answer.score_against_optimum|float_formatter:5 }}</td>
                            <td {% if answer.winner_against_optimum %}class="winning"{% endif %}>{{ answer.motivation }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </section>

        <section>
            <h2 class="next-collapsible">Round-Robin Tournament</h2>

            <div class="collapsed-content hidden">
                <p>
                    We ran a round-robin tournament between all the strategies that have been submitted.
                    The idea is the following. For two given strategies, A and B, there are 12
                    possible 'configurations': A can take the role of the first player or B can do
                    so, and there are 6 ways of shuffling the cards. For each pair of players,
                    imagine we play each configuration, say, a million times, and then calculate
                    for each player their average winnings across all the games they played.
                    It is known that these averages must always be between -1.5 and +1.5 dollars.
                    Note that we don't actually need to simulate this tournament, but we can compute
                    the expected winnings directly from the probabilities making up the strategies.
                    This is what is presented below.
                </p>

                {% if user_is_session_admin %}
                    <p class="next-collapsible">
                        Display winners
                    </p>
                    <p class="collapsed-content hidden center-align">
                        {{ formatted_round_robin_winners|safe }}
                    </p>
                {% endif %}

                <table class="lined-table center-margin">
                    <tr>
                        <th>Answer</th>
                        <th>Score</th>
                        <th>Score <br> with Optimum</th>
                        <th>Difference</th>
                    </tr>
                    <tr>
                        <td>OPT: (1, 1, 1/3, 1, 1/3, 0)</td>
                        <td>&mdash;</td>
                        <td> {{ game.simp_poker_res.optimal_strategy_round_robin_score|float_formatter:5 }} ({{ game.simp_poker_res.optimal_strategy_round_robin_position }})</td>
                        <td>&mdash;</td>
                    </tr>
                    {% for answer in answers_sorted_round_robin %}
                        <tr>
                            <td {% if answer.round_robin_position == 1 %}class="winning"{% endif %}>{% include 'include/answer_as_tuple.html' %}</td>
                            <td {% if answer.round_robin_position == 1 %}class="winning"{% endif %}>{{ answer.round_robin_score|float_formatter:5 }} ({{ answer.round_robin_position }})</td>
                            <td {% if answer.round_robin_with_opt_position == 1 %}class="winning"{% endif %}>{{ answer.round_robin_with_opt_score|float_formatter:5 }} ({{ answer.round_robin_with_opt_position }})</td>
                            <td {% if answer.round_robin_position == 1 %}class="winning"{% endif %}>{{ answer.round_robin_with_opt_score|subtract:answer.round_robin_score|float_formatter:5 }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </section>

        {% if user_is_session_admin %}
            <section class="warning-section">
                <h2 class="next-collapsible">Round-Robin Tournament with Names</h2>

                <div class="collapsed-content hidden">
                    <table class="lined-table center-margin">
                        <tr>
                            <th>Answer</th>
                            <th>Score</th>
                            <th>Score <br> with Optimum</th>
                            <th>Difference</th>
                            <th>Justification</th>
                        </tr>
                        <tr>
                            <td>OPT: (1, 1, 1/3, 1, 1/3, 0)</td>
                            <td>&mdash;</td>
                            <td> {{ game.simp_poker_res.optimal_strategy_round_robin_score|float_formatter:5 }}</td>
                            <td>&mdash;</td>
                            <td></td>
                        </tr>
                        {% for answer in answers_sorted_round_robin %}
                            <tr>
                                <td {% if answer.round_robin_winner %}class="winning"{% endif %}>{{ answer.player.display_name }}</td>
                                <td {% if answer.round_robin_winner %}class="winning"{% endif %}>{% include 'include/answer_as_tuple.html' %}</td>
                                <td {% if answer.round_robin_winner %}class="winning"{% endif %}>{{ answer.round_robin_score|float_formatter:5 }}</td>
                                <td {% if answer.round_robin_winner %}class="winning"{% endif %}>{{ answer.round_robin_with_opt_score|float_formatter:5 }}</td>
                                <td {% if answer.round_robin_winner %}class="winning"{% endif %}>{{ answer.round_robin_with_opt_score|subtract:answer.round_robin_score|float_formatter:5 }}</td>
                                <td {% if answer.round_robin_winner %}class="winning"{% endif %}>{{ answer.motivation }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            </section>
        {% endif %}

        <section>
            <h2 class="next-collapsible">Best Responses</h2>


            <div class="collapsed-content hidden">
              <p>We can compute a best response to each strategy, showing that no strategy can ever be optimal against every possible oppponent.</p>

                <table class="lined-table center-margin">
                    <tr>
                        <th>Answer</th>
                        <th>Best Response</th>
                        <th>Score Against Best Response</th>
                    </tr>
                    {% for answer in answers_sorted_round_robin %}
                        <tr>
                            <td>{% include 'include/answer_as_tuple.html' %}</td>
                            <td>{{ answer.best_response }}</td>
                            <td>{{ answer.score_against_best_response|float_formatter:5 }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </section>

        <section>
            <h2 class="next-collapsible">Globally Best Response</h2>
            <div class="collapsed-content hidden">
                <p>
                    We can also compute the best response given the pool of strategies that have been submitted.
                </p>

                <p class="center-align">
                    {{ game.simp_poker_res.global_best_response }}
                </p>

                <p>
                    Playing the best response, would have lead to a score of {{ game.simp_poker_res.global_best_response_rr_score|float_formatter:5 }}
                    in the round-robin tournament.
                </p>
            </div>
        </section>
    {% else %}
        <section>
            <p>No answer has been submitted yet.</p>
        </section>
    {% endif %}
{% endblock %}


{% block extra_scripts %}
    <script>
        let count = 0;
        function appearOneByOne() {
            const items = document.getElementsByClassName("show-one-by-one");
            if(count < items.length) {
                items[count++].style.display = "table-row";
            }
        }
    </script>
{% endblock %}