{% extends 'core/base.html' %}{% load static %}

{% block title %}{{ session.name }}{% endblock %}

{% block header %}
    <h1>{{ session.long_name }}</h1>
{% endblock %}

{% block logout_next %}?next={% if session.visible %}{% url 'core:session_portal' session.url_tag %}{% else %}{% url 'core:index' %}{% endif %}{% endblock %}

{% block side_panel_extra_nav %}
    {% if user_is_session_admin %}
        {% include 'include/sidepanel_nav_session.html' %}
    {% endif %}
{% endblock %}

{% block content %}
    {% if not session.visible %}
        <section class="warning-section">
            <p>This session is not visible, you are only seeing this page because you are an administrator of the session!</p>
        </section>
    {% endif %}

    <section>
        <h2>Join the Session</h2>

        {% if player_profile %}
            <p>
                You are currently logged in under the user account <em>{{ user.display_name }}</em>. We have
                found a player profile linked to that account for this session.
            </p>

            <p class="center-align">
                <span><a class="button" href="{% url 'core:session_home' session.url_tag %}">Join the session as {{ player_profile.name }}</a></span>
            </p>
        {% else %}
            {% if user_is_authenticated %}
                <p>
                    To participate in the session you need a player profile.
                    {% if session.show_create_account %}
                        Use the form below to create a player profile for this session.
                    {% else %}
                        Unfortunately, it is no longer possible to create a player profile for this
                        session.
                    {% endif %}
                </p>
            {% else %}
                {% if login_form and guest_form %}
                    <div class="side-by-side-two-columns-wrapper">
                {% endif %}
                {% if login_form %}
                    <div>
                        <h3>Log in to an Existing Account</h3>

                        <form action="{% url 'core:session_portal' session.url_tag %}" method="post">
                            {% include "include/form_table_template.html" with form=login_form form_type='login_form' submit_button_label='Log in' %}
                        </form>
                    </div>
                {% endif %}

                {% if guest_form %}
                    <div>
                        <h3>Continue as a Guest</h3>

                        <p class="center-align" style="margin-bottom: 0">
                            <button onclick="generateRandomName()">Generate random name</button>
                        </p>
                        <form action="{% url 'core:session_portal' session.url_tag %}" method="post">
                            {% include "include/form_table_template.html" with form=guest_form form_type='guest_form' submit_button_label='Continue as guest' %}
                        </form>
                    </div>
                {% endif %}
                {% if login_form and guest_form %}
                    </div>
                {% endif %}
            {% endif %}
        {% endif %}
    </section>

    {% if not user_is_authenticated and registration_form %}
        <section id="registration">
            <h2>Create a Player Profile</h2>
            {% if player_creation_error %}
                <p class="form-error">There was a general problem here: {{ player_creation_error }}. Please report that to the admin.</p>
            {% endif %}
            <form action="{% url 'core:session_portal' session.url_tag %}#registration" method="post">
                {% include "include/form_table_template.html" with form=registration_form form_type='registration_form' submit_button_label='Register as a Player' %}
            </form>
        </section>
    {% endif %}

{% endblock %}

{% block extra_scripts %}
    <script>
        function generateRandomName() {
            const letters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let randomLetters = '';
            for (let i = 0; i < 15; i++) {
                randomLetters += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            document.getElementById('id_guest_name').value = randomLetters;
        }
    </script>

{% endblock %}
