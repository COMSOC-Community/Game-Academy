<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'include/head_base_content.html' %}
    <title>{% block title %}Game Server{% endblock %}</title>
    {% block extra_head %}{% endblock %}
</head>

<body>
    <header>
        {% block header %}{% endblock %}
    </header>

    {% if request.user.is_authenticated %}
        <div class="side-panel">
            <h3>
                {{ request.user.display_name|title }}
                <span><a class="button" href="{% url 'core:logout' %}{% block logout_next %}{% endblock %}">Logout</a></span>
            </h3>
            <div class="side-panel-content">


                {% if not request.user.is_guest_player %}
                    <p><a class="button process-button" href="{% url 'core:change_password' %}">Change your Password</a></p>
                {% endif %}

                <h4>Navigation</h4>
                {% if request.user.is_player %}
                    {% with request.user.players.first.session as session %}
                        <span><a class="button navigation-button" href="{% url 'core:session_home' session.url_tag %}">Session home</a></span>
                        {% if request.user.administrated_sessions.all %}
                            <span><a class="button navigation-button" href="{% url "core:session_admin" session.url_tag %}">Admin page</a></span>
                        {% endif %}
                    {% endwith %}
                {% else %}
                    <p><a class="button navigation-button" href="{% url 'core:index' %}">Main page</a></p>
                    <p><a class="button navigation-button" href="{% url 'core:create_session' %}">Create a session</a></p>

                    {% if request.user.administrated_sessions.all %}
                        <h4>Administrated Sessions</h4>
                            {% for session in request.user.administrated_sessions.all %}
                                <p><a class="button navigation-button" href="{% url "core:session_portal" session.url_tag %}">{{ session.name }}</a></p>
                            {% endfor %}
                    {% endif %}
                    {% if request.user.players.all %}
                        <h4>Player profiles</h4>
                        {% for player in request.user.players.all %}
                            <p>
                                <a class="button navigation-button" href="{% url "core:session_home" player.session.url_tag %}">{{ player.name }} for session {{ player.session.name }}</a>
                            </p>
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <main class="truncated-main">
    {% else %}
        <main class="full-main">
    {% endif %}

        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>&copy; 2023 Simon Rey</p>
    </footer>

    {% if request.user.is_authenticated %}
        <script>
            function adjustSidePanel() {
                const header = document.querySelector('header');
                const footer = document.querySelector('footer');
                const sidePanel = document.querySelector('.side-panel');
                const windowHeight = window.innerHeight || document.documentElement.clientHeight;
                const visibleFooterHeight = Math.max(0, windowHeight - footer.getBoundingClientRect().top);
                const visibleHeaderHeight = Math.max(0, header.getBoundingClientRect().bottom);
                const maxHeightOffset = visibleHeaderHeight + visibleFooterHeight + 80;
                const topOffset = visibleHeaderHeight + 40
                sidePanel.style.top = topOffset + 'px';
                sidePanel.style.maxHeight = 'calc(100% - ' + maxHeightOffset + 'px)';
            }

            document.addEventListener("DOMContentLoaded", function() {
                adjustSidePanel();
            });

            window.addEventListener("scroll", function() {
                adjustSidePanel();
            });
        </script>
    {% endif %}

    {% block extra_scripts %}{% endblock %}
</body>
</html>