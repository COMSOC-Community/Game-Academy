{% load static %}
{% load core_extras %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Iterated Prisoner's Dilemma | Results</title>
	<link rel="stylesheet" type="text/css" href="{% static 'css/mainstyle.css' %}"/>
	<link rel="stylesheet" type="text/css" href="{% static 'css/ipdstyle.css' %}"/>
	<script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>

{% if game.results_visible or admin_user %}

    <h1>Results {{ game.game_setting.long_name }} - Session {{ session.long_name }}</h1>

    <div class="navigation">
        <span class="navigation-button">
            <a href="{% url 'itepris_game:index' session.slug_name game.url_tag %}">&#8610;&nbsp;To game home</a>
        </span>
        <br>
        <span class="navigation-button">
            <a href="{% url 'core:session_home' session.slug_name %}">&#8610;&nbsp;To session home</a>
        </span>
    </div>

    {% if admin_user %}
        <div class="adminDiv">
            <div class="warning-box">
                <p>Here are so admin shortcuts if you want to use them.</p>

                {% if game.playable %}
                    <p>Players can currently submit their answers.</p>
                    <form method="post" action="{% url 'itepris_game:results' session.slug_name game.url_tag %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="game_playable"/>
                        <p class="center-align">
                            <input class="green-button" type="submit" value="Close the Game"/>
                        </p>
                    </form>
                {% else %}
                    <p>The game is closed, player can no longer submit their answers.</p>
                    <form method="post" action="{% url 'itepris_game:results' session.slug_name game.url_tag %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="game_playable"/>
                        <p class="center-align">
                            <input class="green-button" type="submit" value="Open the Game"/>
                        </p>
                    </form>
                {% endif %}

                {% if game.results_visible %}
                    <p>The results are visible by all players.</p>
                    <form method="post" action="{% url 'itepris_game:results' session.slug_name game.url_tag %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="results_visible"/>
                        <p class="center-align">
                            <input class="green-button" type="submit" value="Hide the Results"/>
                        </p>
                    </form>
                {% else %}
                    <p>Players cannot currently see the results.</p>
                    <form method="post" action="{% url 'itepris_game:results' session.slug_name game.url_tag %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="results_visible"/>
                        <p class="center-align">
                            <input class="green-button" type="submit" value="Show the Results"/>
                        </p>
                    </form>
                {% endif %}
                <p>
                    To manually run the management commands, click the following button. This is normally unnecessary,
                    unless you changed the entries of the database directly, or performed some other manual actions.
                </p>
                <form method="post" action="{% url 'itepris_game:results' session.slug_name game.url_tag %}">
                    {% csrf_token %}
                        <input type="hidden" name="form_type" value="run_management"/>
                    <p class="center-align">
                        <input class="green-button" type="submit" value="Run Management Commands"/>
                    </p>
                </form>
            </div>
        </div>
    {% endif %}

    {% if answers %}

        <h2>General Results</h2>

        <table class="center-margin lined-table">
            <thead>
                <tr>
                    <th>Team</th>
                    <th>Strategy</th>
                    <th>Average Score</th>
                </tr>
            </thead>
            <tbody>
                {% for answer in answers %}
                    <tr>
                        <td {% if answer.winner %}class="winning"{% endif %}>
                            <a href="#{{ answer.team.name }}">{{ answer.team.name }}</a>
                        </td>
                        <td {% if answer.winner %}class="winning"{% endif %}>{{ answer.name }}</td>
                        <td {% if answer.winner %}class="winning"{% endif %}>{{ answer.avg_score|floatformat:5 }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        {% for answer in answers %}

            <hr class="hr-separator">

            <h2 id="{{ answer.team.name }}">Team {{ answer.team.name }}: {{ answer.name }}</h2>

            {% if admin_user %}
                <p>
                    <a class="collapsible">Display the members of the team:</a>

                    <span class="collapsible-content" style="display: none">
                        {% for p in answer.team.players.all %}
                            {% if forloop.last %}
                                {{ p.name }}.
                            {% else %}
                                {{ p.name }},
                            {% endif %}
                        {% endfor %}
                    </span>
                </p>
            {% endif %}

            <div class="automata-display">
                <svg id="svg_automata_{{ answer.id }}" width="400" height="250"></svg>
            </div>
            <script>
                var dataset_{{ answer.id }} = {{ answer.graph_json_data|safe }};

                var svg_{{ answer.id }} = d3.select("#svg_automata_{{ answer.id }}"),
                    width = +svg_{{ answer.id }}.attr("width"),
                    height = +svg_{{ answer.id }}.attr("height"),
                    g_{{ answer.id }} = svg_{{ answer.id }}.append("g")
                        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

                var simulation_{{ answer.id }} = d3.forceSimulation(dataset_{{ answer.id }}.nodes)
                    .force("charge", d3.forceManyBody().strength(-80))
                    .force("link", d3.forceLink(dataset_{{ answer.id }}.edges).distance(20).strength(1).iterations(10))
                    .force("x", d3.forceX())
                    .force("y", d3.forceY())
                    .stop();

                for (var i = 0; i < 120; ++i) simulation_{{ answer.id }}.tick();

                g_{{ answer.id }}.append("g")
                    .attr("stroke", "#000")
                    .attr("stroke-width", 1.5)
                    .selectAll("line")
                    .data(dataset_{{ answer.id }}.edges)
                    .enter().append("line")
                    .attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

                g_{{ answer.id }}.append("g")
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1.5)
                    .selectAll("circle")
                    .data(dataset_{{ answer.id }}.nodes)
                    .enter().append("circle")
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; })
                    .attr("r", 4.5);
            </script>


            <p class="center-align">
                {% if admin_user %}
                    <a class="collapsible">Display the score:</a>
                    <span class="collapsible-content" style="display: none">
                        {{ answer.formatted_avg_score|floatformat:5 }}
                    </span>
                {% else %}
                    Average score of the strategy: <em>{{ answer.formatted_avg_score|floatformat:5 }}</em>
                {% endif %}
            </p>

            <p class="center-align">
                {{ answer.motivation }}
            </p>

            <p class="collapsible"><a>See the detail of the scores.</a></p>

            <div class="collapse_content" style="display:none;">
                <table class="lined-table center-margin">
                    <thead>
                        <tr>
                            <th>Opponent</th>
                            <th>#Rounds</th>
                            <th>Average Score</th>
                            <th>Average Score Opponent</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for score in answer.scores.all %}
                            <tr>
                                <td>{{ score.opponent.name }}</td>
                                <td>{{ score.number_round }}</td>
                                <td>{{ score.answer_avg_score|floatformat:5 }}</td>
                                <td>{{ score.opp_avg_score|floatformat:5 }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}

        <script>
            var coll = document.getElementsByClassName("collapsible");
            var i;
            for (i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    var content = this.nextElementSibling;
                    if (content.style.display === "none"){
                        content.style.display = "inline";
                    } else {
                        content.style.display = "none";
                    }
                });
            }
        </script>
    {% endif %}


    <div class="navigation">
        <span class="navigation-button">
            <a href="{% url 'itepris_game:index' session.slug_name game.url_tag %}">&#8610;&nbsp;To game home</a>
        </span>
        <br>
        <span class="navigation-button">
            <a href="{% url 'core:session_home' session.slug_name %}">&#8610;&nbsp;To session home</a>
        </span>
    </div>
{% else %}
    <p>The results are not visible.</p>
{% endif %}
</body>
</html>